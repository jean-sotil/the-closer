name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version type (patch, minor, major)"
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
      prerelease:
        description: "Pre-release identifier (e.g., beta, rc)"
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write

env:
  NODE_VERSION: "20"
  PNPM_VERSION: "10"

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.new_version }}
      tag: ${{ steps.version.outputs.tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run tests
        run: pnpm test
        env:
          CI: true

      - name: Calculate new version
        id: version
        run: |
          CURRENT=$(node -p "require('./package.json').version")
          echo "Current version: $CURRENT"

          # Parse version
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"

          # Increment based on input
          case "${{ inputs.version }}" in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
          esac

          NEW_VERSION="$MAJOR.$MINOR.$PATCH"

          # Add prerelease if specified
          if [ -n "${{ inputs.prerelease }}" ]; then
            NEW_VERSION="$NEW_VERSION-${{ inputs.prerelease }}"
          fi

          echo "New version: $NEW_VERSION"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Update package.json versions
        run: |
          # Update root package.json
          npm version ${{ steps.version.outputs.new_version }} --no-git-tag-version

          # Update workspace packages
          for pkg in apps/dashboard packages/*; do
            if [ -f "$pkg/package.json" ]; then
              cd $pkg
              npm version ${{ steps.version.outputs.new_version }} --no-git-tag-version
              cd - > /dev/null
            fi
          done

      - name: Generate changelog
        id: changelog
        run: |
          # Get commits since last tag
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          if [ -n "$LAST_TAG" ]; then
            COMMITS=$(git log $LAST_TAG..HEAD --pretty=format:"- %s (%h)" --no-merges)
          else
            COMMITS=$(git log --pretty=format:"- %s (%h)" --no-merges -20)
          fi

          # Categorize commits
          FEATURES=$(echo "$COMMITS" | grep -i "^- feat" || true)
          FIXES=$(echo "$COMMITS" | grep -i "^- fix" || true)
          OTHERS=$(echo "$COMMITS" | grep -v -i "^- feat\|^- fix" || true)

          # Build changelog
          CHANGELOG="## What's Changed\n\n"

          if [ -n "$FEATURES" ]; then
            CHANGELOG+="### âœ¨ Features\n$FEATURES\n\n"
          fi

          if [ -n "$FIXES" ]; then
            CHANGELOG+="### ðŸ› Bug Fixes\n$FIXES\n\n"
          fi

          if [ -n "$OTHERS" ]; then
            CHANGELOG+="### ðŸ“ Other Changes\n$OTHERS\n\n"
          fi

          # Save to file for the release
          echo -e "$CHANGELOG" > RELEASE_NOTES.md

          # Output for GitHub
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo -e "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Commit version bump
        run: |
          git add -A
          git commit -m "chore(release): v${{ steps.version.outputs.new_version }}"
          git push

      - name: Create and push tag
        run: |
          git tag -a "${{ steps.version.outputs.tag }}" -m "Release ${{ steps.version.outputs.tag }}"
          git push origin "${{ steps.version.outputs.tag }}"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Release ${{ steps.version.outputs.tag }}
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: ${{ inputs.prerelease != '' }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Notify release
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "text": "ðŸŽ‰ New release: ${{ steps.version.outputs.tag }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*New Release Published* ðŸŽ‰\n\n*Version:* `${{ steps.version.outputs.tag }}`\n*Type:* ${{ inputs.version }}\n*Release:* ${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true
